<!--
Merve Erdogan - 11.25.25
Feature Dependent Temporal Attention - Tapping
----------------------------------------------
Experiment details: 
- 1 pair of features: Color and Size
- 4 conditions: Color attended (Size distractor) vs. Size attended (Color distractor)
- Task: tapping the attended feature (color or size) as fast as possible
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Yale Psychology Experiment</title>
    <script src='https://perceptionexperiments.net/ME/jspsych/jspsych.js'></script>
    <link href="https://perceptionexperiments.net/ME/jspsych/css/jspsych.css" rel="stylesheet" type="text/css">

    <!--Special JS files-->
    <script defer src="../99-commonJS/scriptTagConfig.js"></script>
    <script src="expJS/params.js"></script>
    <script src="../99-commonJS/functions.js"></script>
    <script src="../99-commonJS/rhytmicFeatureChangeTask.js"></script>
    <script src="../99-commonJS/instructionPractice.js"></script>
    <script src="expJS/instructions.js"></script>
</head>

<body style="background-color:white;"></body>


<script>

    /*
    ==========================
    EXPERIMENT START
    ==========================
    */
    timeline = [];
    var experiment_start_time = new Date();
    fullscreenActive = false;

    /*
    ===============================================================
    INTRO & INSTRUCTION PROCEDURE
    ===============================================================
    */
    //intro variables are defined in the function.js file
    if (runIntro == true) {
        timeline.push(check_device, consent, survey, enter_fullscreen)
    }


    // //instruction variables are defined in the instructions_xxx.js file
    if (runInstr == true) {
        // Filter out any undefined instructions
        const filteredInstructions = instructions.filter(instr => instr !== undefined);
        timeline.push(...filteredInstructions);
    }


    /*
    ===============================================================
                            TESTING PROCEDURE
    ===============================================================
    */
    trialNum = 1;
    function pushSingleTrial(conditionIndex) {

        var getInstrStimulus = function () {
            return conditions.attendedFeature[conditionIndex] === "color"
                ? "<div style='display: inline-block; margin: 0 auto; color: " + text_color + "; font-size: 30px; text-align: center'><p><div style='color: red; display: inline-block;'>Track Color</div> changes and <div style='color: red; display: inline-block;'>ignore Size</div> changes.</p><p>Press Enter to start the display.</p></div>"
                : "<div style='display: inline-block; margin: 0 auto; color: " + text_color + "; font-size: 30px; text-align: center'><p><div style='color: red; display: inline-block;'>Track Size</div> changes and <div style='color: red; display: inline-block;'>ignore Color</div> changes.</p><p>Press Enter to start the display.</p></div>";
        };

        var attendedFeatureInstr = {
            timeline: [
                {
                    type: "html-keyboard-response",
                    stimulus: getInstrStimulus,
                    choices: jsPsych.NO_KEYS,
                    trial_duration: 400 //to make sure they read the instruction
                },
                {
                    type: "html-keyboard-response",
                    stimulus: getInstrStimulus,
                    choices: ["Enter"],
                    response_ends_trial: true
                }
            ]
        }

        var ITI = {
            type: "html-keyboard-response",
            stimulus: ["<p style='color: white; font-size: 50px; text-align: center'>+</p>"],
            choices: jsPsych.NO_KEYS,
            response_ends_trial: false,
            trial_duration: Math.random() * 500 + 500, //500-1000ms
        }
        var trial = {
            type: "rhytmicFeatureChangeTask", // plugin: ../99-commonJS/rhytmicFeatureChangeTask.js
            //trial-wise changing condition parameters
            attendedFeature: conditions.attendedFeature[conditionIndex],
            attendedTempo: conditions.tempoTargetDist[conditionIndex][0],
            distractorTempo: conditions.tempoTargetDist[conditionIndex][1],

            //general parameters
            displayDuration: paramsGeneral.displayDuration,
            rectBaseSize: [paramsGeneral.baseWidth, paramsGeneral.baseHeight],
            sizeChangeRate: paramsGeneral.sizeChangeRate,
            sizeTempo: conditions.attendedFeature[conditionIndex] === "size" ? conditions.tempoTargetDist[conditionIndex][0] : conditions.tempoTargetDist[conditionIndex][1],
            baseColor: paramsGeneral.baseColor,
            colorChangeRate: paramsGeneral.colorChangeRate,
            colorTempo: conditions.attendedFeature[conditionIndex] === "color" ? conditions.tempoTargetDist[conditionIndex][0] : conditions.tempoTargetDist[conditionIndex][1],
            responseKey: " ",
            data: { trial_category: "test" },
            on_finish: function (data) {
                data.trial = trialNum;
                trialNum++;
            }
        };
        timeline.push(attendedFeatureInstr, ITI, trial);
    }

    for (c = 0; c < totalTrialNum; c++) {
        pushSingleTrial(c);
    }


    /*
    ===============================================================
    CLOSING PROCEDURE
    ===============================================================
    */
    //closing variables are in the function file
    timeline.push(cursor_on, finishing, debreif_qs, exit_fullscreen, closing);

    jsPsych.init({
        timeline: timeline,
        on_interaction_data_update: function (data) {
            viewport_width = get_viewport_size().width;
            viewport_height = get_viewport_size().height;
            data.screen_width = viewport_width;
            data.screen_height = viewport_height;

            // Only check for fullscreen exit if fullscreen has been activated
            if (fullscreenActive && exp_complete == false) {
                if (JSON.stringify(data).includes('blur') || JSON.stringify(data).includes('fullscreenexit')) {
                    data.fullscreen_exited = true;  // Flag for fullscreen exit

                    // Show a warning and a button to re-enter fullscreen
                    if (!document.getElementById('fullscreen-warning')) {
                        var warningDiv = document.createElement('div');
                        warningDiv.id = 'fullscreen-warning';
                        warningDiv.style.position = 'fixed';
                        warningDiv.style.top = '0';
                        warningDiv.style.left = '0';
                        warningDiv.style.width = '100%';
                        warningDiv.style.height = '100%';
                        warningDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.9)'; // Red background
                        warningDiv.style.zIndex = '9999';
                        warningDiv.style.display = 'flex';
                        warningDiv.style.flexDirection = 'column';
                        warningDiv.style.justifyContent = 'center';
                        warningDiv.style.alignItems = 'center';
                        warningDiv.style.color = 'white';
                        warningDiv.innerHTML = `
                        <p style="font-size: 24px;">You have exited fullscreen mode. Please return to fullscreen to continue.</p>
                        <button id="return-fullscreen" style="font-size: 18px; padding: 10px 20px;">Return to Fullscreen</button>
                            `;
                        document.body.appendChild(warningDiv);

                        // Add event listener to the button to re-enter fullscreen
                        document.getElementById('return-fullscreen').addEventListener('click', function () {
                            document.documentElement.requestFullscreen();
                        });
                    }
                } else {
                    // If they are back in fullscreen, remove the warning
                    var warningDiv = document.getElementById('fullscreen-warning');
                    if (warningDiv) {
                        document.body.removeChild(warningDiv);
                    }
                }
            }
        },
    })
</script>
</body>

</html>