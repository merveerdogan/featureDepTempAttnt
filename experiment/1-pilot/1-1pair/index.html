<!--
Merve Erdogan - 11.25.25
Feature Dependent Temporal Attention - Tapping
----------------------------------------------
Experiment details: 
- 1 pair of features: Color and Size
- 2 conditions: Color attended (Size distractor) vs. Size attended (Color distractor)
- Task: tapping the attended feature (color or size) as fast as possible
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <title>Yale Psychology Experiment</title>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/jspsych.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-html-keyboard-response.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-image-keyboard-response.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-html-button-response.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-preload.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-audio-keyboard-response.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-fullscreen.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-browser-check.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-survey-html-form.js"></script>
    <script type="text/javascript" src="lib/vendors/jspsych-7.1.2/plugin-call-function.js"></script>
    <script type="text/javascript" src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>

    <link rel="stylesheet" type="text/css" href="lib/vendors/jspsych-7.1.2/jspsych.css" />

    <script src="helpers/params.js"></script>
    <script src="helpers/functions.js"></script>
    <script src="helpers/instructionPractice.js"></script>
    <script src="helpers/rhytmicFeatureChangeTask.js"></script>
    <script src="helpers/instructions.js"></script>
</head>

<body>
    <dialog id="lostFullscreen" style="text-align:center;background-color:lightgrey">
        <b>Oops!</b> It looks like you exited fullscreen mode.
        <br />
        <button id="returnFullscreen" onclick="on_check_fullscreen_click()">Back to fullscreen</button>
    </dialog>
    <div id="experiment_content" class="full_height"></div>
</body>

<script>
    /*
    ==========================
    EXPERIMENT START
    ==========================
    */
    var experiment_start_time = new Date();
    fullscreenActive = false;

    /* initialize jsPsych */
    var jsPsych = initJsPsych({
        // on_finish: function () {
        //     jsPsych.data.displayData();
        // }
    });


    var timeline = [];
    var pavlovia_init = {
        type: jsPsychPavlovia,
        command: 'init'
    };
    timeline.push(pavlovia_init);

    var prolific_PID = getURLParameter('PROLIFIC_PID');
    var hitID = getURLParameter('STUDY_ID');
    var assignmentID = getURLParameter('SESSION_ID');
    let subj_id = prompt("If the following participant ID is not correct please enter your ID: " + prolific_PID + "", "");

    if (prolific_PID != null && prolific_PID != "" && prolific_PID != 'no_query') {
        participantID = exp_version + "_" + prolific_PID;
    } else {
        participantID = exp_version + "_" + subj_id.toString();
    }
    if (typeof experiment_start_time === 'undefined') {
        experiment_start_time = [];
    }

    // Convert to Date objects if they're not already
    let startTime;
    if (experiment_start_time instanceof Date) {
        startTime = experiment_start_time;
    } else if (Array.isArray(experiment_start_time) && experiment_start_time.length > 0) {
        startTime = new Date(experiment_start_time[0]);
    } else if (typeof experiment_start_time === 'string') {
        startTime = new Date(experiment_start_time);
    } else {
        startTime = new Date(); // Fallback to current time
    }

    jsPsych.data.addProperties({
        participantID: participantID,
        experimentStartTime: formatReadableDate(startTime),
        browser: browserInfo,
    });


    /*
    ==========================
    INTRO & INSTRUCTIONS        
    ==========================
    */
    if (runIntro == true) {
        timeline.push(checkDevice, openEndedQuestions, enterFullscreen);
    }

    if (runInstr == true) { //only run instructions if runInstr is true 
        timeline.push(...instructions);
    }


    /*
    ===============================================================
                            TESTING PROCEDURE
    ===============================================================
    */
    trialNum = 1;
    function pushSingleTrial(conditionIndex) {

        var getInstrStimulus = function () {
            var text = conditions.attendedFeature[conditionIndex] === "color"
                ? "<p><div style='color: red; display: inline-block;'> <h1>Track Color</h1> </div> changes and <div style='color: red; display: inline-block;'> <h1>ignore Size</h1> </div> changes.</p><p>Press Enter to start the display.</p>"
                : "<p><div style='color: red; display: inline-block;'> <h1>Track Size</h1> </div> changes and <div style='color: red; display: inline-block;'> <h1>ignore Color</h1> </div> changes.</p><p>Press Enter to start the display.</p>";
            return standard_instr_style(text);
        };

        var attendedFeatureInstr = {
            timeline: [
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: getInstrStimulus,
                    choices: 'NO_KEYS',
                    trial_duration: 400, //to make sure they read the instruction
                    data: { trial_category: "attendedFeatureInstr" },
                },
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: getInstrStimulus,
                    choices: ["Enter"],
                    response_ends_trial: true,
                    data: { trial_category: "trialStartWaiting" },
                }
            ]
        }

        var ITI = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p style='color: white; font-size: 50px; text-align: center'>+</p>",
            choices: 'NO_KEYS',
            response_ends_trial: false,
            trial_duration: Math.random() * 500 + 500, //500-1000ms,
            data: { trial_category: "ITI" },
        }

        var trial = {
            type: rhytmicFeatureChangeTask, // plugin: ../99-commonJS/rhytmicFeatureChangeTask.js
            //trial-wise changing condition parameters
            attendedFeature: conditions.attendedFeature[conditionIndex],
            attendedTempo: conditions.tempoTargetDist[conditionIndex][0],
            distractorTempo: conditions.tempoTargetDist[conditionIndex][1],
            startTimeDiff: conditions.startTimeDiff[conditionIndex],

            //general parameters
            displayDuration: paramsGeneral.displayDuration,
            rectBaseSize: [paramsGeneral.baseWidth, paramsGeneral.baseHeight],
            sizeChangeRate: paramsGeneral.sizeChangeRate,
            sizeTempo: conditions.attendedFeature[conditionIndex] === "size" ? conditions.tempoTargetDist[conditionIndex][0] : conditions.tempoTargetDist[conditionIndex][1],
            baseColor: paramsGeneral.baseColor,
            colorChangeRate: paramsGeneral.colorChangeRate,
            colorTempo: conditions.attendedFeature[conditionIndex] === "color" ? conditions.tempoTargetDist[conditionIndex][0] : conditions.tempoTargetDist[conditionIndex][1],
            responseKey: " ",
            data: { trial_category: "test" },
            on_finish: function (data) {
                data.trial = trialNum;
                trialNum++;
            }
        };
        timeline.push(attendedFeatureInstr, ITI, trial);
    }

    for (c = 0; c < totalTrialNum; c++) {
        pushSingleTrial(c);
    }

    /*
    ==========================
    CLOSING SECTION
    ==========================
    */
    timeline.push(cursor_on, finishing, debreif_qs, closing);

    var pavlovia_finish = {
        type: jsPsychPavlovia,
        command: 'finish',
    };
    timeline.push(pavlovia_finish);

    jsPsych.run(timeline);
</script>
</body>

</html>